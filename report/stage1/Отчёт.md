# Отчёт

- Содержание отчёта

# Нагрузочное тестирование(wrk2)

Нам необходимо было произвести нагрузочное тестирование. Для этого мы используем утилиту **wrk2**. Произведем тестирование в течение 5 минут, используя 1 поток и одно активное соединение с пропускной способностью 1000 запросов в секунду. 

## PUT-запросы

```bash
MacBook-Pro-Aleksandr:report aleksandrholod$ wrk2 -c1 -t1 -d5m -R1000 -L -s put.lua http://localhost:8080
Running 5m test @ http://localhost:8080
  1 threads and 1 connections
  Thread calibration: mean lat.: 1.132ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    19.82ms  167.49ms   2.31s    98.50%
    Req/Sec     1.06k   653.46    33.11k    98.54%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.16ms
 75.000%    1.51ms
 90.000%    1.92ms
 99.000%  888.83ms
 99.900%    2.14s 
 99.990%    2.28s 
 99.999%    2.31s 
100.000%    2.31s 

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.086     0.000000            1         1.00
       0.387     0.100000        29015         1.11
       0.741     0.200000        58055         1.25
       0.884     0.300000        87031         1.43
       1.022     0.400000       116089         1.67
       1.158     0.500000       145043         2.00
       1.227     0.550000       159588         2.22
       1.298     0.600000       173997         2.50
       1.368     0.650000       188653         2.86
       1.437     0.700000       203040         3.33
       1.514     0.750000       217559         4.00
       1.557     0.775000       224752         4.44
       1.620     0.800000       232040         5.00
       1.706     0.825000       239250         5.71
       1.803     0.850000       246566         6.67
       1.867     0.875000       253774         8.00
       1.895     0.887500       257462         8.89
       1.922     0.900000       261011        10.00
       1.950     0.912500       264723        11.43
       1.977     0.925000       268263        13.33
       2.006     0.937500       271947        16.00
       2.020     0.943750       273692        17.78
       2.036     0.950000       275610        20.00
       2.051     0.956250       277362        22.86
       2.069     0.962500       279324        26.67
       2.087     0.968750       281061        32.00
       2.099     0.971875       281955        35.56
       2.115     0.975000       282831        40.00
       2.137     0.978125       283660        45.71
       2.199     0.981250       284566        53.33
     104.383     0.984375       285464        64.00
     322.047     0.985938       285917        71.11
     540.671     0.987500       286371        80.00
     758.783     0.989062       286824        91.43
     976.895     0.990625       287278       106.67
    1195.007     0.992188       287731       128.00
    1303.551     0.992969       287957       142.22
    1413.119     0.993750       288184       160.00
    1521.663     0.994531       288410       182.86
    1630.207     0.995313       288637       213.33
    1738.751     0.996094       288863       256.00
    1793.023     0.996484       288976       284.44
    1847.295     0.996875       289089       320.00
    1901.567     0.997266       289203       365.71
    1955.839     0.997656       289316       426.67
    2010.111     0.998047       289430       512.00
    2036.735     0.998242       289486       568.89
    2064.383     0.998437       289543       640.00
    2091.007     0.998633       289600       731.43
    2117.631     0.998828       289656       853.33
    2144.255     0.999023       289712      1024.00
    2158.591     0.999121       289743      1137.78
    2172.927     0.999219       289773      1280.00
    2185.215     0.999316       289799      1462.86
    2199.551     0.999414       289829      1706.67
    2211.839     0.999512       289856      2048.00
    2217.983     0.999561       289870      2275.56
    2224.127     0.999609       289882      2560.00
    2230.271     0.999658       289896      2925.71
    2238.463     0.999707       289913      3413.33
    2244.607     0.999756       289925      4096.00
    2250.751     0.999780       289932      4551.11
    2256.895     0.999805       289939      5120.00
    2265.087     0.999829       289948      5851.43
    2271.231     0.999854       289954      6826.67
    2277.375     0.999878       289961      8192.00
    2281.471     0.999890       289966      9102.22
    2283.519     0.999902       289968     10240.00
    2287.615     0.999915       289972     11702.86
    2289.663     0.999927       289974     13653.33
    2293.759     0.999939       289979     16384.00
    2295.807     0.999945       289981     18204.44
    2295.807     0.999951       289981     20480.00
    2297.855     0.999957       289983     23405.71
    2299.903     0.999963       289986     27306.67
    2301.951     0.999969       289988     32768.00
    2301.951     0.999973       289988     36408.89
    2301.951     0.999976       289988     40960.00
    2303.999     0.999979       289991     46811.43
    2303.999     0.999982       289991     54613.33
    2303.999     0.999985       289991     65536.00
    2306.047     0.999986       289993     72817.78
    2306.047     0.999988       289993     81920.00
    2306.047     0.999989       289993     93622.86
    2306.047     0.999991       289993    109226.67
    2306.047     0.999992       289993    131072.00
    2308.095     0.999993       289995    145635.56
    2308.095     1.000000       289995          inf
#[Mean    =       19.824, StdDeviation   =      167.493]
#[Max     =     2306.048, Total count    =       289995]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  299999 requests in 5.00m, 19.17MB read
Requests/sec:   1000.00
Transfer/sec:     65.43KB
```

После проведения тестирования мы получили следующие результаты:

- 50% приходящих запросов у нас обрабатываются до 1.16 ms
- 75% приходящих запросов у нас обрабатываются до 1.51 ms
- 90% приходящих запросов у нас обрабатываются до 1.92 ms
- 99% приходящих запросов у нас обрабатываются до 883.83 ms
- 99.900% приходящих запросов у нас обрабатываются до 2.14 ms
- 99.990% приходящих запросов у нас обрабатываются до 2.28 ms
- 99.999% приходящих запросов у нас обрабатываются до 2.31 ms
- 100% приходящих запросов у нас обрабатываются за 2.31 ms

По сравнению с предыдущим тестированием было изменено время (с 1 минуты до 5), а также было изменено количество запросов ( с 15000 тысяч до 5000, а затем и до 1000 тысячи.

C 90% по 99% у нас происходит задержка (с 1.92 ms до 883.83 ms). Могу предположить, что это происходит из-за того, что запросы взаимодействуют с оперативной памятью, а при выполнении приходится писать данные на диск. 

## GET-запросы

```bash
MacBook-Pro-Aleksandr:report aleksandrholod$ wrk2 -c1 -t1 -d5m -R1000 -L -s get.lua http://localhost:8080
Running 5m test @ http://localhost:8080
  1 threads and 1 connections
  Thread calibration: mean lat.: 4.509ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.19ms  485.39us   4.76ms   65.69%
    Req/Sec     1.05k    92.04     1.33k    78.55%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.18ms
 75.000%    1.54ms
 90.000%    1.83ms
 99.000%    2.22ms
 99.900%    2.33ms
 99.990%    2.43ms
 99.999%    3.21ms
100.000%    4.77ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.092     0.000000            1         1.00
       0.554     0.100000        29067         1.11
       0.767     0.200000        58128         1.25
       0.914     0.300000        87024         1.43
       1.048     0.400000       116053         1.67
       1.180     0.500000       145004         2.00
       1.247     0.550000       159631         2.22
       1.315     0.600000       174036         2.50
       1.382     0.650000       188517         2.86
       1.454     0.700000       203039         3.33
       1.544     0.750000       217506         4.00
       1.592     0.775000       224832         4.44
       1.637     0.800000       232014         5.00
       1.686     0.825000       239387         5.71
       1.732     0.850000       246522         6.67
       1.779     0.875000       253756         8.00
       1.804     0.887500       257387         8.89
       1.829     0.900000       261076        10.00
       1.856     0.912500       264722        11.43
       1.885     0.925000       268290        13.33
       1.918     0.937500       271928        16.00
       1.937     0.943750       273730        17.78
       1.959     0.950000       275544        20.00
       1.987     0.956250       277343        22.86
       2.024     0.962500       279121        26.67
       2.073     0.968750       280940        32.00
       2.097     0.971875       281895        35.56
       2.119     0.975000       282768        40.00
       2.141     0.978125       283687        45.71
       2.163     0.981250       284623        53.33
       2.183     0.984375       285546        64.00
       2.193     0.985938       285965        71.11
       2.203     0.987500       286398        80.00
       2.213     0.989062       286824        91.43
       2.225     0.990625       287339       106.67
       2.235     0.992188       287754       128.00
       2.241     0.992969       287969       142.22
       2.247     0.993750       288213       160.00
       2.253     0.994531       288414       182.86
       2.261     0.995313       288680       213.33
       2.269     0.996094       288881       256.00
       2.273     0.996484       288976       284.44
       2.279     0.996875       289126       320.00
       2.283     0.997266       289207       365.71
       2.291     0.997656       289341       426.67
       2.299     0.998047       289456       512.00
       2.301     0.998242       289484       568.89
       2.309     0.998437       289560       640.00
       2.315     0.998633       289612       731.43
       2.321     0.998828       289663       853.33
       2.329     0.999023       289713      1024.00
       2.335     0.999121       289743      1137.78
       2.339     0.999219       289768      1280.00
       2.347     0.999316       289797      1462.86
       2.355     0.999414       289826      1706.67
       2.361     0.999512       289855      2048.00
       2.367     0.999561       289873      2275.56
       2.369     0.999609       289881      2560.00
       2.377     0.999658       289899      2925.71
       2.383     0.999707       289912      3413.33
       2.389     0.999756       289925      4096.00
       2.391     0.999780       289932      4551.11
       2.395     0.999805       289940      5120.00
       2.403     0.999829       289945      5851.43
       2.411     0.999854       289953      6826.67
       2.417     0.999878       289958      8192.00
       2.431     0.999890       289963      9102.22
       2.435     0.999902       289965     10240.00
       2.451     0.999915       289969     11702.86
       2.461     0.999927       289972     13653.33
       2.469     0.999939       289976     16384.00
       2.485     0.999945       289978     18204.44
       2.495     0.999951       289979     20480.00
       2.513     0.999957       289981     23405.71
       2.559     0.999963       289983     27306.67
       2.583     0.999969       289985     32768.00
       2.673     0.999973       289986     36408.89
       2.673     0.999976       289986     40960.00
       2.983     0.999979       289987     46811.43
       3.065     0.999982       289988     54613.33
       3.085     0.999985       289989     65536.00
       3.215     0.999986       289990     72817.78
       3.215     0.999988       289990     81920.00
       3.215     0.999989       289990     93622.86
       3.435     0.999991       289991    109226.67
       3.435     0.999992       289991    131072.00
       3.935     0.999993       289992    145635.56
       3.935     0.999994       289992    163840.00
       3.935     0.999995       289992    187245.71
       3.935     0.999995       289992    218453.33
       3.935     0.999996       289992    262144.00
       4.767     0.999997       289993    291271.11
       4.767     1.000000       289993          inf
#[Mean    =        1.185, StdDeviation   =        0.485]
#[Max     =        4.764, Total count    =       289993]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  299999 requests in 5.00m, 21.06MB read
Requests/sec:    999.99
Transfer/sec:     71.87KB
```

После проведения тестирования мы получили следующие результаты:

- 50% приходящих запросов у нас обрабатываются до 1.14 ms
- 75% приходящих запросов у нас обрабатываются до 1.48 ms
- 90% приходящих запросов у нас обрабатываются до 1.74 ms
- 99% приходящих запросов у нас обрабатываются до 1.99 ms
- 99.900% приходящих запросов у нас обрабатываются до 2.12 ms
- 99.990% приходящих запросов у нас обрабатываются до 2.24 ms
- 99.999% приходящих запросов у нас обрабатываются до 6.90 ms
- 100% приходящих запросов у нас обрабатываются за 9.33 ms

# Профилирование с помощью async-profiler

Далее нам необходимо произвести профилирование процессорного времени и запросов выделения памяти. Для этого воспользуемся утилитой **async-profiler.**

## PUT-нагрузка

### СPU

![cpu_put](/Users/aleksandrholod/Desktop/2021-highload/2021-highload-dht/report/stage1/pictures/pictures/cpu_put.png)

По результатам профилирования видно следующее:

- Что запись ответа в сокет заняла у нас 12.97%, а чтение запроса заняло 38,41%.
- В реализация нашего метода put большую часть времени отводится под метод Lsm.Dao.upsert  – 16.81%, а на следующем уровне запись на диск (метод LsmDao.flush) использует - 4.38%. Помимо этого запись в оперативную память занимает у нас 12.43% (метод ConcurrentSkipMap.put).

### Alloc

![alloc_put](/Users/aleksandrholod/Desktop/2021-highload/2021-highload-dht/report/stage1/pictures/pictures/alloc_put.png)

Здесь мы видим:

- Большая часть памяти уходит на обработку запроса (handleParsedRequest), а именно 94.07% и также много занимает запись в базу (DAO).

Выводы:

Исходя из этого можно попытаться делать метод upsert и flush асинхронно. Также можно уменьшить количество системных вызовов для записи файла. 

## GET-нагрузка

### CPU

![cpu_get](/Users/aleksandrholod/Desktop/2021-highload/2021-highload-dht/report/stage1/pictures/pictures/cpu_get.png)

По результатам профилирования видно следующие:

- Метод считывания из базы занимает 37.41%. На следующем уровне стека метод LsmDAO.sstableRanges использует 33.55%.
- Запись в сокет занимает у нас порядка 14% процессорного времени.
- Метод get, который мы реализовали занимает 45.89%.

### Alloc

![alloc_get](/Users/aleksandrholod/Desktop/2021-highload/2021-highload-dht/report/stage1/pictures/pictures/alloc_get.png)

- Чтение из базы LsmDao.range использует 54.72% ресурсов оперативной памяти.
- Метод LsmDao.sstableRanges(извлечение данных из БД) занимает 49.45%. Также здесь есть требовательный метод LsmDao.Merge.

Выводы:

Также как и в случаи с PUT-запросами можно добавить асинхронное выполнение, что добавит нам производительности и также можно использовать добавление кэша, что в может дать улучшение.