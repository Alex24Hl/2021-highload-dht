# Отчёт

- Содержание отчёта

# Нагрузочное тестирование(wrk2)

Нам необходимо было произвести нагрузочное тестирование. Для этого мы используем утилиту **wrk2**. Произведем тестирование в течение 1 минуты, используя 4 потока и 200 активных соединение с пропускной способностью 2000 запросов в секунду. 

## PUT-запросы
После проведения оптимизаций, связанных с асинхронной работой метода `flush()` произведём нагрузочное тестирование.
```bash
MacBook-Pro-Aleksandr:report aleksandrholod$ wrk2 -c200 -t4 -d1m -R2000 -L -s put.lua http://localhost:8080
Running 1m test @ http://localhost:8080
  4 threads and 200 connections
  Thread calibration: mean lat.: 2.443ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.078ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.063ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.068ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.33ms  775.71us  16.43ms   72.74%
    Req/Sec   526.11    772.58     5.55k    97.35%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.20ms
 75.000%    1.68ms
 90.000%    2.40ms
 99.000%    3.62ms
 99.900%    4.98ms
 99.990%   10.75ms
 99.999%   16.15ms
100.000%   16.45ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.064     0.000000            1         1.00
       0.485     0.100000         9956         1.11
       0.684     0.200000        19918         1.25
       0.865     0.300000        29875         1.43
       1.036     0.400000        39819         1.67
       1.196     0.500000        49742         2.00
       1.274     0.550000        54748         2.22
       1.356     0.600000        59709         2.50
       1.450     0.650000        64660         2.86
       1.554     0.700000        69650         3.33
       1.677     0.750000        74619         4.00
       1.749     0.775000        77112         4.44
       1.836     0.800000        79587         5.00
       1.935     0.825000        82070         5.71
       2.055     0.850000        84542         6.67
       2.203     0.875000        87049         8.00
       2.295     0.887500        88288         8.89
       2.401     0.900000        89520        10.00
       2.519     0.912500        90782        11.43
       2.639     0.925000        92008        13.33
       2.765     0.937500        93253        16.00
       2.829     0.943750        93870        17.78
       2.895     0.950000        94495        20.00
       2.969     0.956250        95121        22.86
       3.051     0.962500        95734        26.67
       3.139     0.968750        96358        32.00
       3.187     0.971875        96681        35.56
       3.239     0.975000        96980        40.00
       3.301     0.978125        97287        45.71
       3.371     0.981250        97602        53.33
       3.453     0.984375        97916        64.00
       3.491     0.985938        98070        71.11
       3.535     0.987500        98217        80.00
       3.591     0.989062        98374        91.43
       3.647     0.990625        98529       106.67
       3.723     0.992188        98683       128.00
       3.773     0.992969        98761       142.22
       3.821     0.993750        98839       160.00
       3.883     0.994531        98917       182.86
       3.949     0.995313        98994       213.33
       4.081     0.996094        99072       256.00
       4.167     0.996484        99112       284.44
       4.251     0.996875        99150       320.00
       4.335     0.997266        99190       365.71
       4.443     0.997656        99227       426.67
       4.539     0.998047        99266       512.00
       4.611     0.998242        99286       568.89
       4.691     0.998437        99305       640.00
       4.779     0.998633        99325       731.43
       4.915     0.998828        99344       853.33
       4.995     0.999023        99363      1024.00
       5.027     0.999121        99373      1137.78
       5.055     0.999219        99383      1280.00
       5.095     0.999316        99393      1462.86
       5.171     0.999414        99403      1706.67
       5.235     0.999512        99412      2048.00
       5.299     0.999561        99417      2275.56
       5.395     0.999609        99422      2560.00
       5.647     0.999658        99427      2925.71
       5.899     0.999707        99431      3413.33
       6.055     0.999756        99436      4096.00
       6.079     0.999780        99439      4551.11
       6.203     0.999805        99441      5120.00
       9.343     0.999829        99444      5851.43
      10.223     0.999854        99446      6826.67
      10.551     0.999878        99448      8192.00
      10.751     0.999890        99450      9102.22
      11.127     0.999902        99451     10240.00
      11.183     0.999915        99452     11702.86
      11.279     0.999927        99453     13653.33
      11.311     0.999939        99454     16384.00
      15.935     0.999945        99455     18204.44
      15.975     0.999951        99456     20480.00
      15.975     0.999957        99456     23405.71
      16.135     0.999963        99457     27306.67
      16.135     0.999969        99457     32768.00
      16.143     0.999973        99458     36408.89
      16.143     0.999976        99458     40960.00
      16.143     0.999979        99458     46811.43
      16.151     0.999982        99459     54613.33
      16.151     0.999985        99459     65536.00
      16.151     0.999986        99459     72817.78
      16.151     0.999988        99459     81920.00
      16.151     0.999989        99459     93622.86
      16.447     0.999991        99460    109226.67
      16.447     1.000000        99460          inf
#[Mean    =        1.330, StdDeviation   =        0.776]
#[Max     =       16.432, Total count    =        99460]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  119395 requests in 1.00m, 7.63MB read
Requests/sec:   1989.85
Transfer/sec:    130.19KB
```
Результаты нагрузочного тестирования улучшились на два порядка.

## GET-запросы

```bash
MacBook-Pro-Aleksandr:report aleksandrholod$ wrk2 -c200 -t4 -d1m -R1900 -L -s get.lua http://localhost:8080
Running 1m test @ http://localhost:8080
  4 threads and 200 connections
  Thread calibration: mean lat.: 1.038ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.041ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.039ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.044ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.03ms  464.85us   8.90ms   64.73%
    Req/Sec   499.27    121.03     1.00k    79.22%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.00ms
 75.000%    1.36ms
 90.000%    1.65ms
 99.000%    2.15ms
 99.900%    2.62ms
 99.990%    4.64ms
 99.999%    5.46ms
100.000%    8.90ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.105     0.000000            2         1.00
       0.438     0.100000         9454         1.11
       0.589     0.200000        18903         1.25
       0.726     0.300000        28399         1.43
       0.860     0.400000        37821         1.67
       0.999     0.500000        47274         2.00
       1.070     0.550000        52039         2.22
       1.140     0.600000        56710         2.50
       1.211     0.650000        61474         2.86
       1.282     0.700000        66190         3.33
       1.357     0.750000        70917         4.00
       1.399     0.775000        73289         4.44
       1.441     0.800000        75641         5.00
       1.485     0.825000        77980         5.71
       1.534     0.850000        80347         6.67
       1.589     0.875000        82724         8.00
       1.618     0.887500        83904         8.89
       1.649     0.900000        85065        10.00
       1.684     0.912500        86249        11.43
       1.723     0.925000        87425        13.33
       1.768     0.937500        88608        16.00
       1.794     0.943750        89202        17.78
       1.822     0.950000        89781        20.00
       1.854     0.956250        90386        22.86
       1.888     0.962500        90971        26.67
       1.923     0.968750        91556        32.00
       1.946     0.971875        91855        35.56
       1.970     0.975000        92146        40.00
       1.995     0.978125        92439        45.71
       2.027     0.981250        92734        53.33
       2.063     0.984375        93036        64.00
       2.083     0.985938        93184        71.11
       2.105     0.987500        93333        80.00
       2.131     0.989062        93484        91.43
       2.157     0.990625        93626       106.67
       2.185     0.992188        93775       128.00
       2.201     0.992969        93845       142.22
       2.223     0.993750        93923       160.00
       2.245     0.994531        93988       182.86
       2.273     0.995313        94065       213.33
       2.305     0.996094        94136       256.00
       2.323     0.996484        94172       284.44
       2.347     0.996875        94211       320.00
       2.377     0.997266        94248       365.71
       2.403     0.997656        94283       426.67
       2.445     0.998047        94320       512.00
       2.467     0.998242        94338       568.89
       2.493     0.998437        94357       640.00
       2.521     0.998633        94375       731.43
       2.557     0.998828        94394       853.33
       2.659     0.999023        94412      1024.00
       2.739     0.999121        94421      1137.78
       2.879     0.999219        94431      1280.00
       3.035     0.999316        94441      1462.86
       3.149     0.999414        94449      1706.67
       3.287     0.999512        94458      2048.00
       3.483     0.999561        94463      2275.56
       3.547     0.999609        94468      2560.00
       3.627     0.999658        94472      2925.71
       3.879     0.999707        94477      3413.33
       3.983     0.999756        94481      4096.00
       4.127     0.999780        94484      4551.11
       4.267     0.999805        94486      5120.00
       4.303     0.999829        94488      5851.43
       4.455     0.999854        94491      6826.67
       4.579     0.999878        94493      8192.00
       4.611     0.999890        94494      9102.22
       4.635     0.999902        94495     10240.00
       4.647     0.999915        94496     11702.86
       5.243     0.999927        94498     13653.33
       5.255     0.999939        94499     16384.00
       5.255     0.999945        94499     18204.44
       5.267     0.999951        94500     20480.00
       5.267     0.999957        94500     23405.71
       5.287     0.999963        94501     27306.67
       5.379     0.999969        94502     32768.00
       5.379     0.999973        94502     36408.89
       5.379     0.999976        94502     40960.00
       5.379     0.999979        94502     46811.43
       5.459     0.999982        94503     54613.33
       5.459     0.999985        94503     65536.00
       5.459     0.999986        94503     72817.78
       5.459     0.999988        94503     81920.00
       5.459     0.999989        94503     93622.86
       8.903     0.999991        94504    109226.67
       8.903     1.000000        94504          inf
#[Mean    =        1.030, StdDeviation   =        0.465]
#[Max     =        8.896, Total count    =        94504]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  113860 requests in 1.00m, 7.85MB read
Requests/sec:   1897.62
Transfer/sec:    133.91KB
```
Удаление синхронизации при работе с конкурентными структурами данных
многопоточную обработку запросов.


# Профилирование с помощью async-profiler

Далее нам необходимо произвести профилирование процессорного времени и запросов выделения памяти. Для этого воспользуемся утилитой **async-profiler.**

## PUT-нагрузка

### СPU

[cpu_put](cpu_put.html)

По результатам профилирования видно следующее:

- Запись в ConcurrentSkipListMap является самой дорогостоящей операцией (4.85%) в нашей реализации.
- Наибольшее время занимает запись в сокет

### Lock

[lock_put](lock_put.html)

Здесь мы видим:

- Отсутствие блокировок

Выводы:
Можно продолжить увеличивать количество буферизованной записи, и попробовать объединить в буффер несколько `Record`.
Возможно объединять несколько системных вызовов метода send в один, чтобы уменьшить количество обращений к ядру из JVM.

## GET-нагрузка

### CPU

[cpu_get](cpu_get.html)

По результатам профилирования видно следующие:

- Метод считывания из базы занимает 33.64%. На следующем уровне стека метод LsmDAO.sstableRanges использует 28.32%.
- Запись в сокет занимает у нас порядка 29.35% процессорного времени.
- Метод get, который мы реализовали занимает 38.41%.

### Lock

[lock_get](lock_get.html)

- Отсутствие блокировок

Выводы:
Большое количество времени тратится на объединение итераторов, его можно сократить не добавляя пустые итераторы, а также выполняя периодическое объединение перезаписанных значений.